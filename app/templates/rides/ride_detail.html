{% extends "base.html" %}

{% block content %}
    <h1>Ride Details</h1>
    <div class="card">
        <div class="card-header">
             {{ ride.origin }} to {{ ride.destination }}
        </div>
        <div class="card-body">
            <h5 class="card-title">Driver: <a href="{{ url_for('users.profile', username=ride.driver.username) }}">{{ ride.driver.username }}</a></h5>
            <p class="card-text"><strong>Departure:</strong> {{ ride.departure_time.strftime('%Y-%m-%d %H:%M') }}</p>
            <p class="card-text"><strong>Seats Available:</strong> {{ ride.seats_available }}</p>
            <p class="card-text"><strong>Price per Seat:</strong> ${{ "%.2f"|format(ride.price_per_seat or 0) }}</p>
            {% if ride.description %}
                <p class="card-text"><strong>Description:</strong> {{ ride.description }}</p>
            {% endif %}

            {% if current_user.is_authenticated %}
                {% if current_user.id == ride.driver_id %}
                    <p><span class="badge bg-info">This is your ride</span></p>
                    <form action="{{ url_for('rides.delete_ride', ride_id=ride.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this ride?');" style="display: inline;">
                         <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                         <button type="submit" class="btn btn-danger btn-sm">Delete Ride</button>
                     </form>
                     {% elif existing_booking %}
                     <p><span class="badge bg-success">You have booked this ride (Status: {{ existing_booking.status }})</span></p>
                     {% if existing_booking.status != 'cancelled' %}
                     <form action="{{ url_for('rides.cancel_booking', booking_id=existing_booking.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to cancel your booking?');">
                         <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                         <button type="submit" class="btn btn-warning btn-sm">Cancel Booking</button>
                     </form>
                     {% endif %}
                {% elif ride.seats_available > 0 %}
                    <form action="{{ url_for('rides.book_ride', ride_id=ride.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-primary">Book 1 Seat</button>
                    </form>
                {% else %}
                     <p><span class="badge bg-secondary">Ride Full</span></p>
                {% endif %}
            {% else %}
                <p><a href="{{ url_for('auth.login', next=request.url) }}">Log in</a> to book this ride.</p>
            {% endif %}

        </div>
        <div class="card-footer text-muted">
            Offered on: {{ ride.created_at.strftime('%Y-%m-%d') }}
        </div>
    </div>

    {% endblock %}